#!/usr/bin/env bash

while true; do
    if [[ ! -f "$PGDATA/recovery.conf" ]] ; then
        until psql -l -t >/dev/null 2>&1; do sleep 1; done

        # Push a fresh backup so we have a new recovery baseline
        echo "Performing an initial backup..."
        envdir "$WALE_ENVDIR" wal-e backup-push "$PGDATA"
        echo "Backup has been completed."
        break
    fi
    sleep 1
done
